# DirtyRobot

Робот для обработки rss и автоматического постинга на dirty.ru

В каждом файле есть коннект к базе данных.
В **poster.php**, в функции **sendPost** надо поставить **sid** и **uid** пользователя dirty, от которого будут добавляться посты.

Для работы нужны четыре таблицы: **aqueue**, **squeue**, **dqueue** и **feeds**.

  Таблицы **aqueue**, **squeue**, **dqueue** имеют такую структуру:
  ```
	id	  int(4)    unsigned	No	Primary	NULL	auto_increment
	dt	  int(4)    unsigned	No	None	  NULL	
	link	longtext	          No	None	  NULL	
	json	longtext	          No	None	  NULL
  ```
  Таблица **feeds** такая:
  ```
  name	        text              No  None  	NULL	
  rssLink	      text	            No	None  	NULL	
  lastFetchTime	int(4)  unsigned	No	Primary	NULL	
  lastItemTime	int(4)  unsigned	No	None	  NULL
  ```
  
  **scinews.php** - это скрипт который непосредственно собирает посты по rss. Он проверяет таблицу **feeds** и берёт строку которую не проверяли дольше всех (**lastFetchTime**). Далее запрашивает фид, строит массив постов, дата и время которых старше **lastItemTime**. Проверяется один фид за запуск. Если новых постов нет - ничего и не происходит. Если новые посты есть - они обрабатываются под формат dirty API и записываются в базу, в таблицу **aqueue** уже сразу в json (предварительно скорвертированным в base64). 
  
  **accept.php** - этот GUI скрипт обработки очереди постов (которые лежат в таблице **aqueue**). Вызывается пользователем(модератором), который выбирает, публиковать ли этот пост или нет. Если пост публикуется - пост перемещается в таблицу **squeue**, есть отбрасывается - в таблицу **dqueue**.
  
  **action.php** - вызывается из **accept.php** и непосредственно перемещает пост из **aqueue** в **squeue** или **dqueue**.
  
  **poster.php** - этот скрипт непосредственно добавляет посты на сайт dirty.ru. По одному за раз. Берёт пост из таблицы **squeue** и пытается послать на сайт. Если удачно - пост удаляется из таблицы, если нет - пробуем следующий пост и так 10 раз. Если все 10 раз с ошибками - прерываемся.
  
  
